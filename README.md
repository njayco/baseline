# Baseline - Melody to Sheet Music

**Beat it. See it. Export it.**

Baseline is a web application that converts recorded beatbox and drum performances into professional percussion sheet music notation. Built with a dark, modern UI featuring vibrant orange accents, Baseline offers both mobile and desktop editing modes and follows a "free to create, pay to export" business model.

An Unrevealed Brand by UV Music Group.

---

## Features

### Beatbox-First Audio Transcription
- Record beatbox performances directly in the browser using the device microphone via the MediaRecorder API
- DSP-based onset detection pipeline locks event count deterministically before any AI involvement
- Short-time energy envelope and spectral flux detect transient onsets with configurable thresholds
- Silence gap detection automatically inserts rest events
- BPM-based quantization snaps detected hits to a rhythmic grid (1/8 or 1/16 note subdivision)
- AI classification pass (gpt-4o-mini) only labels detected hits (kick, snare, closed hat, open hat, clap, tom, rim, perc) and never invents or removes notes
- Additional input sources (humming, whistling, piano, drums) marked as "Coming soon"

### Sheet Music Rendering
- Real-time sheet music display powered by VexFlow
- Percussion clef with standard drum notation mapping (kick on space below, snare on middle line, hi-hat on top with x noteheads)
- Treble clef support for future melodic instruments
- Displays score title, artist name, time signature, and key
- Desktop mode shows a full-page paper-style score view
- Mobile mode provides a compact wrapped staff layout

### Notation Color Customization
- 6 preset color schemes: Classic Orange, Ocean Blue, Forest Green, Royal Purple, Rose Pink, Monochrome
- Colors apply to notes, active highlights, staff lines, rests, and beams
- Accessible from Desktop sidebar and Mobile settings panel

### Playback Engine
- Tone.js-based drum synthesis with distinct sounds per drum type:
  - Kick: sine wave frequency drop
  - Snare: noise burst with bandpass filter
  - Hi-hat: high-passed noise with fast decay
  - Toms: sine waves at varying pitches
- Transport controls: Play/Pause, Stop, Replay
- Real-time note highlighting during playback (active notes glow in the selected accent color)
- Deduplication of overlapping timestamps prevents Tone.js scheduling crashes

### Dual Interface Modes
- **Mobile Mode**: Streamlined recording interface with a large record button, elapsed time display, instrument selector grid, settings drawer for score metadata and color customization
- **Desktop Mode**: DAW-style editor with a sidebar containing transport controls, score info fields, vertical instrument selector, notation color picker, BPM slider, quantization toggle, and export options. Main area shows a scrollable paper-style score

### Free Downloads
- **PDF**: Client-side PDF generation from the VexFlow SVG using jspdf + svg2pdf.js. Includes score title, artist name, and "Generated by Baseline" header. Note colors converted to dark for print readability
- **Audio Recording**: Download the raw recorded audio file directly from the browser

### Premium Export Formats
- **MusicXML** ($0.99) — Industry-standard notation format compatible with Finale, Sibelius, MuseScore, and other notation software
- **MIDI** ($1.99) — Standard MIDI file with accurate tick timing, velocity mapping, and tempo meta-events
- Multi-format checkout: select MusicXML + MIDI in a single Stripe session with combined line items

### Stripe Payment Integration
- Stripe Checkout for paid exports with secure session-based payment verification
- Export records tracked in the database with Stripe session IDs
- Server-side validation: export IDs must belong to the claimed score and match expected formats before accepting payment
- Download endpoint enforces payment status before serving files
- Webhook integration for real-time payment event processing

### Score Management
- Full CRUD operations for scores stored in PostgreSQL
- Editable score title and artist name on both mobile and desktop
- Undo last note, clear session, and save functionality
- Scores persist note events as JSONB (supports DrumNoteEvent, RestEvent, MelodicNoteEvent)

---

## Tech Stack

| Layer | Technology |
|-------|-----------|
| Frontend | React 19, Vite 7, TypeScript, Tailwind CSS 4 |
| UI Components | Radix UI primitives, shadcn/ui, Lucide icons |
| Routing | Wouter |
| Sheet Music | VexFlow 5 |
| Playback | Tone.js |
| PDF Export | jspdf, svg2pdf.js |
| Backend | Express 5, TypeScript (tsx) |
| Database | PostgreSQL (Neon) via Drizzle ORM |
| AI | OpenAI gpt-4o-mini (drum hit classification only) |
| Audio Processing | ffmpeg (WebM/MP4/OGG to WAV conversion) |
| DSP | Custom onset detection (energy envelope, spectral flux) |
| Payments | Stripe Checkout, stripe-replit-sync |
| Deployment | Replit |

---

## Project Structure

```
├── client/
│   ├── src/
│   │   ├── pages/
│   │   │   ├── Landing.tsx              # Mode selection (mobile/desktop)
│   │   │   ├── Mobile.tsx               # Mobile recording interface
│   │   │   ├── Desktop.tsx              # Desktop DAW-style editor
│   │   │   └── CheckoutSuccess.tsx      # Post-payment success page
│   │   ├── components/
│   │   │   ├── Staff.tsx                # VexFlow sheet music renderer (percussion + treble)
│   │   │   ├── InstrumentSelector.tsx   # Input source picker
│   │   │   ├── TransportControls.tsx    # Playback transport (Play/Pause, Stop, Replay)
│   │   │   ├── ExportPanel.tsx          # Free + premium export with Stripe checkout
│   │   │   └── NotationColorPicker.tsx  # Color scheme preset selector
│   │   └── lib/
│   │       ├── audio-engine.ts          # MediaRecorder + API transcription
│   │       ├── playback/
│   │       │   └── player.ts            # Tone.js playback engine with drum synthesis
│   │       └── types.ts                 # Type definitions + notation color presets
│   └── index.html
├── server/
│   ├── index.ts                         # Express server setup + Stripe init
│   ├── routes.ts                        # API routes (CRUD, transcription, export, checkout)
│   ├── storage.ts                       # Database storage layer (Drizzle)
│   ├── db.ts                            # PostgreSQL connection
│   ├── lib/
│   │   ├── drum-transcriber.ts          # DSP onset detection + quantization
│   │   ├── musicxml.ts                  # MusicXML file generation
│   │   └── midi-export.ts              # MIDI file generation
├── shared/
│   └── schema.ts                        # Drizzle ORM schema + Zod validation
├── package.json
├── tsconfig.json
├── drizzle.config.ts
└── vite.config.ts
```

---

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/api/scores` | List all scores |
| `POST` | `/api/scores` | Create a new score |
| `GET` | `/api/scores/:id` | Get a single score |
| `PATCH` | `/api/scores/:id` | Update a score |
| `DELETE` | `/api/scores/:id` | Delete a score |
| `POST` | `/api/scores/:id/notes` | Append notes to a score |
| `POST` | `/api/transcribe-notes` | Transcribe audio (DSP + AI classification) |
| `POST` | `/api/scores/:id/checkout` | Create multi-format Stripe checkout session |
| `POST` | `/api/verify-payment` | Verify Stripe payment and mark exports paid |
| `GET` | `/api/scores/:id/export/:format/download` | Download exported file (requires payment) |
| `GET` | `/api/scores/:id/export/json` | Free JSON export |

---

## How It Works

1. **Record**: User opens mobile or desktop mode and taps Record. The browser captures audio via `MediaRecorder` using the best available codec (WebM/Opus preferred).

2. **DSP Onset Detection**: Audio is sent to the server, converted to normalized mono WAV (44.1kHz) via ffmpeg. The DSP pipeline in `drum-transcriber.ts` computes a short-time energy envelope (frame=1024, hop=256) and spectral flux to detect transient onsets. A minimum inter-onset interval (100ms) prevents double-counting. Silence gaps above a threshold automatically generate rest events.

3. **BPM Quantization**: Detected onset times are quantized to the nearest rhythmic grid position based on the score's BPM and subdivision setting (1/8 or 1/16 note).

4. **AI Classification**: Only the detected hits (exact count locked by DSP) are sent to gpt-4o-mini with a strict prompt that returns exactly N labels for N hits. The AI never adds or removes events.

5. **Render**: DrumNoteEvent and RestEvent arrays stream into the VexFlow-powered `Staff` component, rendering standard percussion notation with proper noteheads, stems, beams, and measure bars.

6. **Playback**: Tone.js synthesizes drum sounds with distinct synthesis per drum type. Active notes highlight in real time on the staff.

7. **Export**: Free PDF and audio downloads are available instantly. Premium formats (MusicXML, MIDI) go through Stripe Checkout. After payment verification, the server generates and serves the file.

---

## Transcription Pipeline Thresholds

| Parameter | Default | Description |
|-----------|---------|-------------|
| `onsetThreshold` | 0.12 | Energy threshold for onset detection (higher = fewer false positives) |
| `minInterOnsetMs` | 100ms | Minimum time between onsets to prevent double-counting |
| `silenceRmsThreshold` | 0.02 | RMS level below which audio is considered silence |
| `restMinMs` | 200ms | Minimum silence duration to generate a rest event |
| `subdivision` | 8 | Rhythmic grid resolution (8 = 1/8 notes, 16 = 1/16 notes) |

Set `DEBUG_DRUM_TRANSCRIBE=true` as an environment variable for verbose logging of the DSP pipeline.

---

## Database Schema

### `scores`
Stores score metadata and note events as JSONB. Supports DrumNoteEvent, RestEvent, and MelodicNoteEvent types. Fields: `id`, `title`, `artist`, `bpm`, `time_signature`, `notes` (JSONB), `instrument`, `created_at`, `updated_at`.

### `exports`
Tracks export requests and payment status. Fields: `id`, `score_id` (FK), `format`, `price_cents`, `stripe_session_id`, `paid`, `created_at`.

### `conversations` / `messages`
Chat and AI conversation history tables for future features.

---

## Design

- **Theme**: Dark background with vibrant orange (#FF6600 / hsl 25 100% 50%) accents
- **Fonts**: Audiowide (display/branding), Inter (UI text), JetBrains Mono (monospace/technical)
- **Score View**: Paper-textured white background with serif typography for an authentic sheet music feel
- **Color Schemes**: 6 notation color presets (Orange, Blue, Green, Purple, Rose, Monochrome)
- **Animations**: Smooth fade-in transitions, pulse effects during recording, gradient ambient backgrounds

---

## License

MIT
